<!DOCTYPE html>
<html>

<head>
    <title>TODO supply a title</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script>
        var rattrs = /([^=\s]+)(?:\s*=\s*(\S+))?/
        var str = `<div id="xxx" class="ddd">dd{ a ? <span>你好 </span> : <hr h=99 /> } 44 </div>`
        var str = `<div id="xxx" class="ddd">dd{ a ? <span>你好 </span> : <br /> } 44 </div>`
        var str = `<div id={222}>{aaa.map(function(){return <p>ddd</p> })}</div>`

        var str =
            `<ul>
                {
                    data.length > 0 && 
                    data.map((element, index) => {
                       <li key={index}>{element}</li> 
                    })
                }
            </ul>`
        var str =
            `  <li>
      <input type="checkbox" checked={todo.done}>
      <span className={'done-' + todo.done}>{todo.text}</span>
    </li>`
        var str = `<div class="ddd">{props.number} is an {description} number</div><p>{aaa}</p>`
        var str = '<div>{this.props.children}</div>'
        var str = `<div style={{color: '#ff0000', fontSize: '14px'}}>Hello World.</div>`
        var str = `<div>
                <h1>
                    <a href="https://github.com/kuy/redux-saga-examples/tree/master/autocomplete">Autocomplete</a>
                    from
                    <a href="https://github.com/kuy/redux-saga-examples">redux-saga-examples</a>
                    by
                    <a href="https://twitter.com/kuy">@kuy</a>
                </h1>
                <h3>Type "c" to start suggestions. It starts completion lazily.</h3>
                <Suggest
                    suggestions={suggests}
                    onSuggestionsFetchRequested={this
                    .handleSuggest
                    .bind(this)}
                    onSuggestionsClearRequested={this
                    .handleClear
                    .bind(this)}
                    renderSuggestion={s => <span>{s.name}</span>}
                    getSuggestionValue={s => s.name}
                    inputProps={props}/>
            </div>`
        var elIndex = 4

        var rlineSp = /\\n\s*/g
        var rfill = /\?\?\d+/g

        function nomalString(str, bag) {
            return str.replace(rfill, function(a) {
                return bag[a]
            })
        }

        function readLogic(str) {
            var end, s = 0
            var ret = []
            for (var i = 0, n = str.length; i < n; i++) {
                var c = str.charAt(i)
                if (!end) {
                    if (c === "{") {
                        end = "}"
                        s = i
                    }
                } else {
                    if (c === end) {
                        ret.push(str.slice(s, i + 1))
                        end = false
                    }
                }
            }
            return ret
        }

        function clearLogic(str, bag) {
            var array = readLogic(str)
            for (var i = 0, n = array.length; i < n; i++) {
                str = str.replace(array[i], function(a) {
                    var index = genIndex()
                    bag[index] = a
                    return index
                })
            }
            return str
        }


        var genIndex = function() {
            return '??' + (elIndex++)
        }

        function genJSX(str) {

            var map = {
                '??0': 'null',
                '??1': 'null)'
            }

            var str2 = str.replace(/\s*<(\w+)([^>]+?)?(\/)?\>/g, function(a, b, c, d) { //处理开标签
                    var n = genIndex()
                    var f = 'React.createElement(' + JSON.stringify(b)
                    map[n] = f
                    var slash = false
                    var attrs = c && c.trim()
                    if (d === '/') {
                        slash = true
                    } else if (c === '/') {
                        slash = true
                        attrs = null
                    }
                    if (attrs) {
                        //处理属性
                        n += genAttrs(attrs, map)
                    } else {
                        n += ',??0,'
                    }
                    //处理半开标签, br
                    if (slash) {
                        n += '??1'
                    }
                    return n
                })
                .replace(/<\/\w+\>/g, function(a, b) { //处理闭标签
                    var n = genIndex()
                    map[n] = '),'
                    return n
                }).replace(/(\?\?\d+)\s*\,([^?{]+){?/g, function(a, b, c) { //处理{边界符前的文本
                    var last = a[a.length - 1] === '{'
                    if (/\S/.test(c)) { //忽略无效的空白
                        var index = genIndex()
                        map[index] = JSON.stringify(c)
                        return b + ',' + index + (last ? ',(' : '')
                    } else {
                        return b + (last ? ',(' : '')
                    }
                })
                .replace(/(\?\?\d+)\s*,\{[^?]+\}/, function(a, b) { //处理{边界符
                    return a.replace(/\}([^}]+)\{/g, function(k, dd) {
                            return '),' + JSON.stringify(dd.trim()) + ",("
                        }).replace("{", "(").replace(/}/, "),")
                        //原来的
                        //  return b + ',('
                })
                .replace(/\}(\?\?\d+)/, function(a, b) { //处理}边界符
                    return ')' + b
                })
                .replace(/(\?\?\d+)\s*\}\s*([^?\)]+)(\?\?\d)/g, function(a, b, c, d) {
                    return b + '),' + JSON.stringify(c.trim()) + d //处理 }边界符后的文本
                })


            console.log(map)
            console.log(str2)

            return str2.replace(/\?\?\d+/g, function(a) {
                return map[a]
            }).replace(/,$/, '')
        }

        function genAttrs(attrs, map) {
            var props = []
            var propsUniq = {}
            var bag = {}
            attrs = clearLogic(attrs, bag)

            while (attrs) {
                var arr = rattrs.exec(attrs)

                if (arr) {
                    attrs = attrs.replace(arr[0], '')
                    var name = arr[1]
                    var value = arr[2]
                    if (name in propsUniq) {
                        continue
                    }
                    propsUniq[name] = 1
                        //处理属性名
                    if (name === 'for') {
                        name = 'htmlFor'
                    } else if (name === 'class') {
                        name = 'className'
                    }

                    if (value) {
                        //https://github.com/RubyLouvre/avalon/issues/1844
                        if (value.indexOf('??') === 0) {
                            value = nomalString(value, bag).
                            replace(rlineSp, '').
                            slice(1, -1)
                        } else if (/^\{.+\}$/.test(value)) {
                            value = "(" + value.slice(1, -1) + ")"
                        }
                    } else {
                        value = 'true'
                    }
                    props.push(name + ':' + value)
                } else {
                    break
                }
            }

            if (props.length) {
                var n = genIndex()
                map[n] = "{" + props.join(',') + "}"
                return "," + n + ","
            } else {
                return ',??0,'
            }
        }




        console.log(genJSX(str))
    </script>
</head>

<body>
    <div>TODO write content</div>
</body>

</html>